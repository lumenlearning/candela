!function(a){as3cfpro.tool={ID:!1,timerCount:0,elapsedInterval:0,$counterDisplay:"",nextStepInUpload:!1,doingAjax:!1,uploadPaused:!1,nonFatalErrors:!1,uploadError:!1,uploadCompleted:!1,uploadCancelled:!1,currentlyProcessing:!1,findAndReplace:!0,progressModalActive:!1,redirectModalActive:!1,progressPercent:0,progressBytes:0,progressTotalBytes:0,progressCount:0,progressTotalCount:0,contentHeight:0,$redirectContent:!1,$progressContent:!1,$progressContentOriginal:!1,$redirectContentOriginal:!1,cloneViews:function(){this.$progressContentOriginal=a(".progress-content").clone(),this.$redirectContentOriginal=a(".redirect-content").clone(),a(".progress-content").remove(),a(".redirect-content").remove()},openModal:function(){this.$redirectContent=this.$redirectContentOriginal.clone();var b=a(document).height();a("body").append('<div id="overlay"></div>'),a("#overlay").height(b).css({position:"fixed",top:0,left:0,width:"100%","z-index":99999,display:"none"}),a("#overlay").after(this.$redirectContent),a("#overlay").show(),a(".redirect-options").on("change",'input[name="existing-links"]',function(b){"nothing"===a(this).val()&&"1"===as3cfpro.settings.remove_local_file?a(".redirect-options .nothing").next(".notice-warning").addClass("show"):a(".redirect-options .nothing").next(".notice-warning").removeClass("show")}),this.contentHeight=this.$redirectContent.outerHeight(),this.$redirectContent.css("top","-"+this.contentHeight+"px").show().animate({top:"0px"}),this.redirectModalActive=!0},init:function(){var b=this;this.$progressContent=this.$progressContentOriginal.clone(),this.findAndReplace="replace"===a('input[name="existing-links"]:checked').val()?!0:!1,this.$redirectContent.animate({top:"-"+b.contentHeight+"px"},400,"swing",function(){a(this).remove(),b.redirectModalActive=!1,a("#overlay").after(b.$progressContent),b.contentHeight=b.$progressContent.outerHeight(),b.$progressContent.css("top","-"+b.contentHeight+"px").show().animate({top:"0px"}),b.progressModalActive=!0,a(".upload-controls .cancel").after('<img src="'+as3cfpro.spinnerUrl+'" alt="" class="upload-progress-ajax-spinner general-spinner" />'),b.setupCounter()}),this.currentlyProcessing=!0,this.doingAjax=!0;var b=this;a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("initiate"),nonce:this.getAjaxNonce("initiate")},error:function(a,c,d){b.ajaxError(a,c,d)},success:function(a){if(!b.as3cfproError(a)){var c={bytes:0,files:0,total_bytes:0,total_files:0};b.nextStepInUpload={fn:b.calculateItemsRecursive,args:[a,c]},b.executeNextStep()}}})},cancel:function(){this.uploadCancelled=!0,this.uploadPaused=!1,a(".upload-controls").fadeOut(),a(".upload-progress-ajax-spinner").show(),a(".progress-text").html(as3cfpro.strings.completing_current_request),!1===this.doingAjax&&this.executeNextStep()},pad:function(a,b,c){return c=c||"0",a+="",a.length>=b?a:new Array(b-a.length+1).join(c)+a},setupCounter:function(){this.timerCount=0,this.$counterDisplay=a(".timer"),this.elapsedInterval=setInterval(this.count(),1e3)},count:function(){this.timerCount=this.timerCount+1,this.displayCount()},displayCount:function(){var a=Math.floor(this.timerCount/3600)%24,b=Math.floor(this.timerCount/60)%60,c=this.timerCount%60,d=this.pad(a,2,0)+":"+this.pad(b,2,0)+":"+this.pad(c,2,0);this.$counterDisplay.html(d)},sizeFormat:function(a){var b=1024,c=["kB","MB","GB","TB","PB","EB","ZB","YB"];if(b>a)return a+" B";var d=-1;do a/=b,d++;while(a>=b);return a.toFixed(1)+" "+c[d]},setPauseResumeButton:function(b){!0===this.uploadPaused?(this.uploadPaused=!1,this.doingAjax=!0,a(".upload-progress-ajax-spinner").show(),a(".pause-resume").html(as3cfpro.strings.pause),this.elapsedInterval=setInterval(this.count(),1e3),this.executeNextStep()):(a(this).off(b),this.uploadPaused=!0,this.doingAjax=!1,a(".pause-resume").html(as3cfpro.strings.pausing).addClass("disabled")),this.updateProgressMessage()},updateProgress:function(b,c,d,e){this.progressBytes=d,this.progressTotalBytes=e,this.progressCount=b,this.progressTotalCount=c,e>0?this.progressPercent=Math.round(100*d/e):this.progressPercent=Math.round(100*this.progressCount/this.progressTotalCount),a(".progress-bar").width(this.progressPercent+"%"),this.updateProgressMessage()},updateProgressMessage:function(){var b=as3cfpro.strings.files_uploaded.replace("%1$d",this.progressCount).replace("%2$d",this.progressTotalCount),c=this.progressPercent+"% "+as3cfpro.strings.complete,d="";this.progressTotalBytes>0&&(d="("+this.sizeFormat(this.progressBytes)+" / "+this.sizeFormat(this.progressTotalBytes)+")"),a(".upload-progress").html(b),!1===this.uploadPaused?a(".progress-text").html(c+" "+d):a(".progress-text").html(as3cfpro.strings.completing_current_request)},getAjaxAction:function(a){return"as3cfpro_"+a+"_"+this.ID},getAjaxNonce:function(a){return as3cfpro.nonces[a+"_"+this.ID]},updateNotice:function(){a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("update_notice"),nonce:this.getAjaxNonce("update_notice")},success:function(b){if(!0===b.success&&"undefined"!=typeof b.data){var c=this.ID+"-remove";a("#"+this.ID).attr("id",c),a("#"+c).after(b.data),a("#"+c).remove()}}})},calculateItemsRecursive:function(b,c){if(_.isEmpty(b))return as3cfpro.tool.updateProgress(c.files,c.total_files,c.bytes,c.total_bytes),as3cfpro.tool.nextStepInUpload={fn:as3cfpro.tool.processItemRecursive,args:[c]},void as3cfpro.tool.executeNextStep();var d=this;a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("calculate_items"),blogs:b,progress:c,nonce:this.getAjaxNonce("calculate_items")},error:function(a,b,c){d.ajaxError(a,b,c)},success:function(a){d.as3cfproError(a)||(as3cfpro.tool.nextStepInUpload={fn:as3cfpro.tool.calculateItemsRecursive,args:[a.blogs,a.progress]},as3cfpro.tool.executeNextStep())}})},processItemRecursive:function(b){return b.files>=b.total_files?(as3cfpro.tool.nextStepInUpload={fn:as3cfpro.tool.processComplete,args:[b]},void as3cfpro.tool.executeNextStep()):void a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("process_items"),find_and_replace:this.findAndReplace,progress:b,nonce:this.getAjaxNonce("process_items")},error:function(a,b,c){this.ajaxError(a,b,c)},success:function(b){if(!this.as3cfproError(b)){if("undefined"!=typeof b.errors){var c=a(".progress-errors-title .error-count"),d=parseInt(c.html());a.each(b.errors,function(b,c){d++,a(".progress-errors .progress-errors-detail ol").append("<li>"+c+"</li>"),this.nonFatalErrors=!0}),d>0&&a(".progress-errors").show(),c.html(d),1===d?a(".progress-errors-title .error-text").html(as3cfpro.strings.error):a(".progress-errors-title .error-text").html(as3cfpro.strings.errors)}as3cfpro.tool.updateProgress(b.files,b.total_files,b.bytes,b.total_bytes),as3cfpro.tool.nextStepInUpload={fn:as3cfpro.tool.processItemRecursive,args:[b]},as3cfpro.tool.executeNextStep()}}})},processCompleteEvents:function(){if(!1===this.uploadError&&!0===this.nonFatalErrors){a(".progress-text").addClass("upload-error");var b=as3cfpro.strings.completed_with_some_errors;!0===this.uploadCancelled&&(b=as3cfpro.strings.partial_complete_with_some_errors),a(".progress-text").html(b)}this.uploadError=!1,this.currentlyProcessing=!1,this.uploadCompleted=!0,this.uploadPaused=!1,this.uploadCancelled=!1,this.doingAjax=!1,this.nonFatalErrors=!1,a(".progress-label").remove(),a(".upload-progress-ajax-spinner").remove(),a(".close-progress-content").show(),a("#overlay").css("cursor","pointer"),clearInterval(this.elapsedInterval),a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:this.getAjaxAction("finish"),nonce:this.getAjaxNonce("finish")},success:function(){this.updateNotice()}})},proceessComplete:function(){a(".upload-controls").fadeOut(),this["this"].currentlyProcessing=!1,!1===this.uploadError&&(a(".progress-text").append('<div class="dashicons dashicons-yes"></div>'),this.processCompleteEvents())},executeNextStep:function(){return!0===this.uploadPaused?(a(".upload-progress-ajax-spinner").hide(),clearInterval(this.elapsedInterval),a(".progress-text").html(as3cfpro.strings.paused),a("body").on("click",".pause-resume",function(a){as3cfpro.tool.setPauseResumeButton(a)}),void a(".pause-resume").html(as3cfpro.strings.resume).removeClass("disabled")):void(!0===this.uploadCancelled?(a(".progress-text").html(as3cfpro.strings.upload_cancelled),this.processCompleteEvents()):as3cfpro.tool.nextStepInUpload.fn.apply(null,as3cfpro.tool.nextStepInUpload.args))},ajaxError:function(b,c,d){a(".progress-title").html(as3cfpro.strings.upload_failed),a(".progress-text").not(".media").html(b.responseText),a(".progress-text").not(".media").addClass("upload-error"),console.log(b),console.log(c),console.log(d),this.uploadError=!0,this.processCompleteEvents(),this.doingAjax=!1},returnError:function(b){this.uploadError=!0,this.processCompleteEvents(),a(".progress-title").html(as3cfpro.strings.upload_failed),a(".progress-text").addClass("upload-error"),a(".progress-text").html(b),a(".upload-controls").fadeOut(),this.doingAjax=!1},as3cfproError:function(a){return"undefined"!=typeof a.as3cfpro_error&&1===a.as3cfpro_error?(this.returnError(a.body),!0):"undefined"!=typeof a.success&&!1===a.success?(this.returnError(a.data),!0):!1},hideOverlay:function(){a(".modal-content").animate({top:"-"+this.contentHeight+"px"},400,"swing",function(){a("#overlay").remove(),a(".modal-content").remove()}),this.uploadCompleted=!1,this.progressModalActive=!1,this.redirectModalActive=!1},maybeHideOverlay:function(){(!0===this.redirectModalActive||!0===this.progressModalActive&&!0===this.uploadCompleted)&&this.hideOverlay()}},window.onbeforeunload=function(a){return as3cfpro.tool.currentlyProcessing?(a=a||window.event,a&&(a.returnValue=as3cfpro.strings.sure),as3cfpro.strings.sure):void 0},a(document).ready(function(){as3cfpro.tool.cloneViews(),a("body").on("click","a.as3cf-pro-tool",function(a){a.preventDefault(),as3cfpro.tool.openModal()}),a("body").on("click",".as3cf-start-upload",function(a){a.preventDefault(),as3cfpro.tool.init()}),a("body").on("click",".pause-resume",function(a){as3cfpro.tool.setPauseResumeButton(a)}),a("body").on("click",".cancel",function(){as3cfpro.tool.cancel()}),a("body").on("click",".close-progress-content-button, .close-redirect-content-button",function(a){as3cfpro.tool.hideOverlay()}),a("body").on("click","#overlay",function(){as3cfpro.tool.maybeHideOverlay()}),a("body").on("click",".toggle-progress-errors",function(b){b.preventDefault();var c=a(this),d=c.closest(".progress-errors-title").siblings(".progress-errors-detail");return d.toggle(0,function(){c.html(a(this).is(":visible")?as3cfpro.strings.hide:as3cfpro.strings.show)}),!1}),a("body").on("click","a.as3cf-pro-notice",function(b){b.preventDefault();var c=a(this);c.closest(".as3cf-notice").hide(),a.ajax({url:ajaxurl,type:"POST",dataType:"json",cache:!1,data:{action:"as3cfpro_dismiss_notice",nonce:as3cfpro.nonces.dismiss_notice,notice:c.data("notice")},error:function(a,b,d){c.closest(".as3cf-notice").show()},success:function(a){!1===a.success&&c.closest(".as3cf-notice").show()}})})})}(jQuery);