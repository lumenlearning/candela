!function(a,b,c){var d=wp.media,e=[];d.view.s3Button=d.view.Button.extend({defaults:{text:"",style:"primary",size:"large",disabled:!1},initialize:function(c){c&&(this.options=c,this.defaults.text=as3cfpro_media.strings[this.options.action]),this.options=b.extend({},this.defaults,this.options),d.view.Button.prototype.initialize.apply(this,arguments),this.listenTo(this.controller,"selection:toggle",this.toggleDisabled),b.bindAll(this,"findAndReplaceResult"),a("body").off("as3cf-find-and-replace").on("as3cf-find-and-replace",".as3cf-find-replace-container",this.findAndReplaceResult)},toggleDisabled:function(){this.model.set("disabled",!this.controller.state().get("selection").length)},click:function(a){if(a.preventDefault(),!this.$el.hasClass("disabled")){var d=this.controller.state().get("selection");if(d.length){var f=!1,g=this,h=[];if(d.each(function(a){h.push(a.id),!f&&g.options.confirm&&a.attributes[g.options.confirm]&&(f=!0)}),e=b.union(e,h),!this.options.confirm||!f||confirm(as3cfpro_media.strings[this.options.confirm])){var i=as3cfpro_media.nonces[this.options.action+"_media"],j={_nonce:i,s3_action:this.options.action,ids:h};if("download"===this.options.action)return this.startS3Action(),void this.fireS3Action(j);h.length>1&&c.setBulk(!0),c.open(null,j)}}}},startS3Action:function(){a(".media-toolbar .spinner").css("visibility","visible").show(),a(".media-toolbar-secondary .button").addClass("disabled")},findAndReplaceResult:function(a,b,d){this.startS3Action(),c.startLoading(),d.find_and_replace=b,this.fireS3Action(d)},fireS3Action:function(a){wp.ajax.send("as3cfpro_process_media_action",{data:a}).done(b.bind(this.returnS3Action,this))},returnS3Action:function(b){b&&""!==b&&(a(".as3cf-notice").remove(),a("#wp-media-grid h2").after(b)),this.controller.trigger("selection:action:done"),a(".media-toolbar .spinner").hide(),a(".media-toolbar-secondary .button").removeClass("disabled"),c.stopLoading(),c.close()},render:function(){return d.view.Button.prototype.render.apply(this,arguments),this.controller.isModeActive("select")?this.$el.addClass("s3-actions-selected-button"):this.$el.addClass("s3-actions-selected-button hidden"),this.toggleDisabled(),this}});var f=d.view.SelectModeToggleButton;d.view.SelectModeToggleButton=f.extend({toggleBulkEditHandler:function(){f.prototype.toggleBulkEditHandler.call(this,arguments);var a=this.controller.content.get().toolbar;this.controller.isModeActive("select")?a.$(".s3-actions-selected-button").removeClass("hidden"):a.$(".s3-actions-selected-button").addClass("hidden")}});var g=d.view.AttachmentsBrowser;d.view.AttachmentsBrowser=g.extend({createToolbar:function(){g.prototype.createToolbar.call(this),this.toolbar.set("copyS3SelectedButton",new d.view.s3Button({action:"copy",controller:this.controller,priority:-60}).render()),this.toolbar.set("removeS3SelectedButton",new d.view.s3Button({action:"remove",controller:this.controller,priority:-60,confirm:"bulk_local_warning"}).render()),this.toolbar.set("downloadS3SelectedButton",new d.view.s3Button({action:"download",controller:this.controller,priority:-60}).render())}});var h=d.view.Attachment.Details.TwoColumn;d.view.Attachment.Details.TwoColumn=h.extend({events:function(){return b.extend({},h.prototype.events,{"click .local-warning":"confirmS3Removal","click .s3-actions a.copy":"confirmFindAndReplace","click .s3-actions a.remove":"confirmFindAndReplace"})},initialize:function(){a(".as3cf-notice").remove();var c=this.model.get("id");if(b.contains(e,c)){var f=d.model.Attachment.get(c),g=f.attributes.url,i=this;a.when(f.fetch()).then(function(){var d=f.attributes.url;g!==d&&(e=b.without(e,c)),h.prototype.initialize.apply(i,arguments),a(".attachment-info .settings").children('label[data-setting="url"]').children("input").val(d)})}h.prototype.initialize.apply(this,arguments)},render:function(){this.fetchS3Details(this.model.get("id"))},fetchS3Details:function(a){wp.ajax.send("as3cfpro_get_attachment_s3_details",{data:{_nonce:as3cfpro_media.nonces.get_attachment_s3_details,id:a}}).done(b.bind(this.renderView,this))},renderView:function(a){h.prototype.render.apply(this),this.renderActionLinks(a),this.renderS3Details(a)},renderActionLinks:function(c){var d=c&&c.links||[],e=this.$el.find(".actions"),f=a("<div />",{"class":"s3-actions"}),g=[];b(d).each(function(a){g.push(a)}),f.append(g.join(" | ")),e.append(f)},confirmS3Removal:function(a){return confirm(as3cfpro_media.strings.local_warning)?void 0:(a.preventDefault(),a.stopImmediatePropagation(),!1)},confirmFindAndReplace:function(b){b.preventDefault(),c.open(a(b.target).attr("href"))},renderS3Details:function(a){if(a&&a.s3object){var b=this.$el.find(".attachment-info .details"),c=this.generateDetails(a.s3object,["bucket","key","region","acl"]);b.append(c)}},generateDetails:function(a,c){var d="";return b(c).each(function(b){a[b]&&(d+='<div class="'+b+'"><strong>'+as3cfpro_media.strings[b]+":</strong> "+a[b]+"</div>")}),d}}),a(document).ready(function(){function b(b){var c='<option value="bulk_as3cfpro_'+b+'">'+as3cfpro_media.strings[b]+"</option>";a('select[name^="action"] option:last-child').after(c)}function d(){b("copy"),b("remove"),b("download")}d(),a("body").on("click",".as3cfpro_remove a.local-warning",function(a){return confirm(as3cfpro_media.strings.local_warning)?!0:(a.preventDefault(),a.stopImmediatePropagation(),!1)}),a("body").on("click",".bulkactions #doaction",function(b){var c=a("#bulk-action-selector-top").val();if("bulk_as3cfpro_remove"!==c)return!0;var d=!1,e=0;return a('input:checkbox[name="media[]"]:checked').each(function(){var b=a(this).parent().siblings(".column-title");return b.find(".row-actions span.as3cfpro_remove a").hasClass("local-warning")?(e++,confirm(as3cfpro_media.strings.bulk_local_warning)&&(d=!0),d):void 0}),e>0?d:!0}),a("#posts-filter").on("submit",function(b){if(a("#bulk-action-selector-top,#bulk-action-selector-bottom").find('option:selected[value^="bulk_as3cfpro_"]').length){if("bulk_as3cfpro_download"===a('#posts-filter select[name="action"]').val())return;b.preventDefault(),c.setBulk(!0),c.open(window.location.origin+window.location.pathname+"?"+a("#posts-filter").serialize())}}),a("body").on("click",".row-actions .as3cfpro_copy a,.row-actions .as3cfpro_remove a",function(b){b.preventDefault(),c.open(a(this).attr("href"))})})}(jQuery,_,as3cfFindAndReplaceMedia);